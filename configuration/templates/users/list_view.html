{% extends "administration/base.html" %}

{% load static %}

{% block title %}Usuários - Gestão Fiscal{% endblock title %}

{% block titlebody %}
<div class="flex items-center px-6 py-4">
    <h2 class="text-2xl font-semibold tracking-tight">
        Usuários do Sistema
    </h2>
</div>
{% endblock titlebody %}

{% block content %}
<div 
    class="px-6 pb-6" 
    x-data="{ 
        deleteModal: false, 
        reactivateModal: false, 
        selectedUser: { pk: null, name: '', deleteUrl: '', reactivateUrl: '' }
    }"
    @open-delete-modal.window="selectedUser = $event.detail; deleteModal = true"
    @open-reactivate-modal.window="selectedUser = $event.detail; reactivateModal = true"
>
    <!-- Filtros -->
    <c-card class="mb-4">
        <c-card.content class="pt-6">
            <form 
                class="flex flex-wrap gap-4 items-center"
                hx-get="{% url 'configuration:user_list' %}" 
                hx-target="#users-table-container" 
                hx-trigger="change from:.filter-control, submit" 
                hx-swap="innerHTML"
                hx-push-url="true"
            >
                <!-- Busca -->
                <div class="relative flex-grow min-w-[200px]">
                    <svg xmlns="http://www.w3.org/2000/svg" class="absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                        <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                        <path d="M10 10m-7 0a7 7 0 1 0 14 0a7 7 0 1 0 -14 0" />
                        <path d="M21 21l-6 -6" />
                    </svg>
                    <c-input 
                        type="text" 
                        class="filter-control pl-10" 
                        placeholder="Buscar por nome ou email" 
                        name="search" 
                        value="{{ current_search }}"
                    />
                </div>
                
                <!-- Filtros de Status -->
                <div class="flex gap-2" x-data="{ status: '{{ current_status|default:'all' }}' }">
                    <input type="hidden" name="status" :value="status">
                    <c-button 
                        type="button"
                        :variant="status === 'all' ? 'default' : 'outline'"
                        size="sm"
                        @click="status = 'all'; $el.closest('form').dispatchEvent(new Event('change'))"
                    >
                        Todos
                    </c-button>
                    <c-button 
                        type="button"
                        :variant="status === 'active' ? 'default' : 'outline'"
                        size="sm"
                        @click="status = 'active'; $el.closest('form').dispatchEvent(new Event('change'))"
                    >
                        Ativos
                    </c-button>
                    <c-button 
                        type="button"
                        :variant="status === 'inactive' ? 'default' : 'outline'"
                        size="sm"
                        @click="status = 'inactive'; $el.closest('form').dispatchEvent(new Event('change'))"
                    >
                        Inativos
                    </c-button>
                </div>

                <c-button type="submit" variant="default">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                        <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                        <path d="M10 10m-7 0a7 7 0 1 0 14 0a7 7 0 1 0 -14 0" />
                        <path d="M21 21l-6 -6" />
                    </svg>
                    Buscar
                </c-button>
            </form>
        </c-card.content>
    </c-card>

    <!-- Tabela de Usuários -->
    <div id="users-table-container">
        {% include "users/partials/user_table.html" %}
    </div>

    <!-- Modal de Desativação -->
    <c-dialog name="deleteModal">
        <c-dialog.content open_var="deleteModal" hide_action="deleteModal = false">
            <c-dialog.icon variant="destructive">
                <c-dialog.title>Desativar Usuário</c-dialog.title>
                <c-dialog.description>
                    Você realmente deseja desativar o usuário <strong x-text="selectedUser.name"></strong>?
                </c-dialog.description>
            </c-dialog.icon>
            
            <c-dialog.footer class="mt-6">
                <c-button variant="outline" type="button" @click="deleteModal = false">
                    Cancelar
                </c-button>
                <form 
                    id="delete-user-form"
                    method="POST"
                    x-bind:action="selectedUser.deleteUrl"
                    x-init="$watch('selectedUser.deleteUrl', value => { 
                        if(value) {
                            $el.setAttribute('hx-post', value);
                            htmx.process($el);
                        }
                    })"
                    hx-target="#users-table-container" 
                    hx-swap="innerHTML"
                    @htmx:after-request="deleteModal = false"
                >
                    {% csrf_token %}
                    <c-button type="submit" variant="destructive">
                        Desativar
                    </c-button>
                </form>
            </c-dialog.footer>
        </c-dialog.content>
    </c-dialog>

    <!-- Modal de Reativação -->
    <c-dialog name="reactivateModal">
        <c-dialog.content open_var="reactivateModal" hide_action="reactivateModal = false">
            <c-dialog.icon variant="success">
                <c-dialog.title>Reativar Usuário</c-dialog.title>
                <c-dialog.description>
                    Você realmente deseja reativar o usuário <strong x-text="selectedUser.name"></strong>?
                </c-dialog.description>
            </c-dialog.icon>
            
            <c-dialog.footer class="mt-6">
                <c-button variant="outline" type="button" @click="reactivateModal = false">
                    Cancelar
                </c-button>
                <form 
                    id="reactivate-user-form"
                    method="POST"
                    x-bind:action="selectedUser.reactivateUrl"
                    x-init="$watch('selectedUser.reactivateUrl', value => { 
                        if(value) {
                            $el.setAttribute('hx-post', value);
                            htmx.process($el);
                        }
                    })"
                    hx-target="#users-table-container" 
                    hx-swap="innerHTML"
                    @htmx:after-request="reactivateModal = false"
                >
                    {% csrf_token %}
                    <c-button type="submit" class="bg-green-600 hover:bg-green-700 text-white">
                        Reativar
                    </c-button>
                </form>
            </c-dialog.footer>
        </c-dialog.content>
    </c-dialog>
</div>
{% endblock content %}
