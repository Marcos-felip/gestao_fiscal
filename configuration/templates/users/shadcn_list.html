{% extends "administration/base.html" %}

{% load static %}

{% block title %}Usuários - Gestão Fiscal{% endblock title %}

{% block titlebody %}
<div class="flex items-center px-6 py-4">
    <h2 class="text-2xl font-semibold tracking-tight">
        Usuários do Sistema
    </h2>
</div>
{% endblock titlebody %}

{% block content %}
<div 
    class="px-6 pb-6" 
    x-data="{ 
        deleteModal: false, 
        reactivateModal: false, 
        selectedUser: { pk: null, name: '', deleteUrl: '', reactivateUrl: '' }
    }"
    @open-delete-modal.window="selectedUser = $event.detail; deleteModal = true"
    @open-reactivate-modal.window="selectedUser = $event.detail; reactivateModal = true"
>
    <!-- Filtros -->
    <c-card class="mb-4">
        <c-card.content class="pt-6">
            <form 
                class="flex flex-wrap gap-4 items-center"
                hx-get="{% url 'configuration:user_list' %}" 
                hx-target="#users-table-container" 
                hx-trigger="change from:.filter-control, submit" 
                hx-swap="innerHTML"
                hx-push-url="true"
            >
                <!-- Busca -->
                <div class="relative flex-grow min-w-[200px]">
                    <svg xmlns="http://www.w3.org/2000/svg" class="absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                        <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                        <path d="M10 10m-7 0a7 7 0 1 0 14 0a7 7 0 1 0 -14 0" />
                        <path d="M21 21l-6 -6" />
                    </svg>
                    <c-input 
                        type="text" 
                        class="filter-control pl-10" 
                        placeholder="Buscar por nome ou email" 
                        name="search" 
                        value="{{ current_search }}"
                    />
                </div>
                
                <!-- Filtros de Status -->
                <div class="flex gap-2" x-data="{ status: '{{ current_status|default:'all' }}' }">
                    <input type="hidden" name="status" :value="status">
                    <c-button 
                        type="button"
                        :variant="status === 'all' ? 'default' : 'outline'"
                        size="sm"
                        @click="status = 'all'; $el.closest('form').dispatchEvent(new Event('change'))"
                    >
                        Todos
                    </c-button>
                    <c-button 
                        type="button"
                        :variant="status === 'active' ? 'default' : 'outline'"
                        size="sm"
                        @click="status = 'active'; $el.closest('form').dispatchEvent(new Event('change'))"
                    >
                        Ativos
                    </c-button>
                    <c-button 
                        type="button"
                        :variant="status === 'inactive' ? 'default' : 'outline'"
                        size="sm"
                        @click="status = 'inactive'; $el.closest('form').dispatchEvent(new Event('change'))"
                    >
                        Inativos
                    </c-button>
                </div>

                <c-button type="submit" variant="default">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                        <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                        <path d="M10 10m-7 0a7 7 0 1 0 14 0a7 7 0 1 0 -14 0" />
                        <path d="M21 21l-6 -6" />
                    </svg>
                    Buscar
                </c-button>
            </form>
        </c-card.content>
    </c-card>

    <!-- Tabela de Usuários -->
    <div id="users-table-container">
        {% include "users/partials/user_table.html" %}
    </div>

    <!-- Modal de Desativação -->
    <div 
        x-show="deleteModal" 
        x-transition:enter="ease-out duration-300"
        x-transition:enter-start="opacity-0"
        x-transition:enter-end="opacity-100"
        x-transition:leave="ease-in duration-200"
        x-transition:leave-start="opacity-100"
        x-transition:leave-end="opacity-0"
        class="fixed inset-0 z-50 flex items-center justify-center"
        x-cloak
        @keydown.escape.window="deleteModal = false"
    >
        <!-- Backdrop -->
        <div class="fixed inset-0 bg-background/80 backdrop-blur-sm" @click="deleteModal = false"></div>
        
        <!-- Modal Content -->
        <div 
            x-transition:enter="ease-out duration-300"
            x-transition:enter-start="opacity-0 scale-95"
            x-transition:enter-end="opacity-100 scale-100"
            x-transition:leave="ease-in duration-200"
            x-transition:leave-start="opacity-100 scale-100"
            x-transition:leave-end="opacity-0 scale-95"
            class="fixed z-50 w-full max-w-md rounded-lg border bg-background p-6 shadow-lg"
        >
            <!-- Close Button -->
            <button 
                type="button" 
                class="absolute right-4 top-4 rounded-sm opacity-70 ring-offset-background transition-opacity hover:opacity-100"
                @click="deleteModal = false"
            >
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M18 6 6 18"></path>
                    <path d="m6 6 12 12"></path>
                </svg>
            </button>
            
            <!-- Icon -->
            <div class="flex flex-col items-center text-center">
                <div class="mx-auto flex h-12 w-12 items-center justify-center rounded-full bg-destructive/10 mb-4">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-destructive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M12 9v4"></path>
                        <path d="M10.363 3.591l-8.106 13.534a1.914 1.914 0 0 0 1.636 2.871h16.214a1.914 1.914 0 0 0 1.636 -2.87l-8.106 -13.536a1.914 1.914 0 0 0 -3.274 0z"></path>
                        <path d="M12 16h.01"></path>
                    </svg>
                </div>
                
                <h3 class="text-lg font-semibold">Desativar Usuário</h3>
                <p class="text-sm text-muted-foreground mt-2">
                    Você realmente deseja desativar o usuário <strong x-text="selectedUser.name"></strong>?
                </p>
            </div>
            
            <!-- Footer -->
            <div class="flex justify-end gap-3 mt-6">
                <c-button variant="outline" type="button" @click="deleteModal = false">
                    Cancelar
                </c-button>
                <form 
                    method="POST"
                    :action="selectedUser.deleteUrl"
                    hx-post
                    :hx-post="selectedUser.deleteUrl"
                    hx-target="#users-table-container" 
                    hx-swap="innerHTML"
                    @htmx:after-request="deleteModal = false"
                >
                    {% csrf_token %}
                    <c-button type="submit" variant="destructive">
                        Desativar
                    </c-button>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal de Reativação -->
    <div 
        x-show="reactivateModal" 
        x-transition:enter="ease-out duration-300"
        x-transition:enter-start="opacity-0"
        x-transition:enter-end="opacity-100"
        x-transition:leave="ease-in duration-200"
        x-transition:leave-start="opacity-100"
        x-transition:leave-end="opacity-0"
        class="fixed inset-0 z-50 flex items-center justify-center"
        x-cloak
        @keydown.escape.window="reactivateModal = false"
    >
        <!-- Backdrop -->
        <div class="fixed inset-0 bg-background/80 backdrop-blur-sm" @click="reactivateModal = false"></div>
        
        <!-- Modal Content -->
        <div 
            x-transition:enter="ease-out duration-300"
            x-transition:enter-start="opacity-0 scale-95"
            x-transition:enter-end="opacity-100 scale-100"
            x-transition:leave="ease-in duration-200"
            x-transition:leave-start="opacity-100 scale-100"
            x-transition:leave-end="opacity-0 scale-95"
            class="fixed z-50 w-full max-w-md rounded-lg border bg-background p-6 shadow-lg"
        >
            <!-- Close Button -->
            <button 
                type="button" 
                class="absolute right-4 top-4 rounded-sm opacity-70 ring-offset-background transition-opacity hover:opacity-100"
                @click="reactivateModal = false"
            >
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M18 6 6 18"></path>
                    <path d="m6 6 12 12"></path>
                </svg>
            </button>
            
            <!-- Icon -->
            <div class="flex flex-col items-center text-center">
                <div class="mx-auto flex h-12 w-12 items-center justify-center rounded-full bg-green-100 mb-4">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-green-600" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="12" cy="12" r="10"></circle>
                        <path d="M9 12l2 2l4 -4"></path>
                    </svg>
                </div>
                
                <h3 class="text-lg font-semibold">Reativar Usuário</h3>
                <p class="text-sm text-muted-foreground mt-2">
                    Você realmente deseja reativar o usuário <strong x-text="selectedUser.name"></strong>?
                </p>
            </div>
            
            <!-- Footer -->
            <div class="flex justify-end gap-3 mt-6">
                <c-button variant="outline" type="button" @click="reactivateModal = false">
                    Cancelar
                </c-button>
                <form 
                    method="POST"
                    :action="selectedUser.reactivateUrl"
                    hx-post
                    :hx-post="selectedUser.reactivateUrl"
                    hx-target="#users-table-container" 
                    hx-swap="innerHTML"
                    @htmx:after-request="reactivateModal = false"
                >
                    {% csrf_token %}
                    <c-button type="submit" class="bg-green-600 hover:bg-green-700 text-white">
                        Reativar
                    </c-button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock content %}
