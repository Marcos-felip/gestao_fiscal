{% extends "administration/base.html" %}

{% load static crispy_forms_tags %}

{% block title %}{% if object %}Editar{% else %}Criar{% endif %} Usuário - Gestão Fiscal{% endblock title %}

{% block titlebody %}
<div class="px-6 py-4">
    <nav class="flex items-center gap-2 text-sm text-muted-foreground mb-2">
        <a href="{% url 'configuration:user_list' %}" class="hover:text-foreground transition-colors">
            Usuários
        </a>
        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
            <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
            <path d="M9 6l6 6l-6 6" />
        </svg>
        <span class="text-foreground">{% if object %}Editar{% else %}Novo{% endif %}</span>
    </nav>
    <h2 class="text-2xl font-semibold tracking-tight">
        {% if object %}Editar Usuário{% else %}Criar Novo Usuário{% endif %}
    </h2>
</div>
{% endblock titlebody %}

{% block content %}
<div class="px-6 pb-6">
    <c-card>
        <c-card.header>
            <c-card.title>
                {% if object %}Editar Usuário{% else %}Criar Novo Usuário{% endif %}
            </c-card.title>
            <c-card.description>
                {% if object %}
                    Atualize as informações do usuário abaixo.
                {% else %}
                    Preencha as informações para criar um novo usuário.
                {% endif %}
            </c-card.description>
        </c-card.header>
        <c-card.content>
            <form method="post" id="user-form" class="space-y-6">
                {% csrf_token %}
                
                <div class="grid gap-6">
                    {{ form|crispy }}
                </div>
                
                {{ form.media }}
            </form>
        </c-card.content>
        <c-card.footer class="flex justify-between border-t pt-6">
            <a href="{% url 'configuration:user_list' %}">
                <c-button variant="outline" type="button">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                        <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                        <path d="M5 12l14 0" />
                        <path d="M5 12l6 6" />
                        <path d="M5 12l6 -6" />
                    </svg>
                    Voltar
                </c-button>
            </a>
            <c-button type="submit" form="user-form">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                    <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                    <path d="M6 4h10l4 4v10a2 2 0 0 1 -2 2h-12a2 2 0 0 1 -2 -2v-12a2 2 0 0 1 2 -2" />
                    <path d="M12 14m-2 0a2 2 0 1 0 4 0a2 2 0 1 0 -4 0" />
                    <path d="M14 4l0 4l-6 0l0 -4" />
                </svg>
                Salvar
            </c-button>
        </c-card.footer>
    </c-card>
</div>
{% endblock content %}

{% block extrajs %}
<script>
$(document).ready(function() {
    $('#id_permissions').select2({
        placeholder: 'Selecione as permissões',
        allowClear: true,
        width: '100%'
    });
    
    const form = document.getElementById('user-form');
    if (!form) return;
    
    const roleSelect = form.querySelector('#id_role');
    const permissionsField = form.querySelector('#id_permissions');
    
    function togglePermissions() {
        if (!roleSelect || !permissionsField) return;
        
        const role = roleSelect.value;
        const permissionsContainer = permissionsField.closest('.mb-3');
        
        if (role === 'admin' || role === 'owner') {
            if (permissionsContainer) permissionsContainer.style.display = 'none';
        } else {
            if (permissionsContainer) permissionsContainer.style.display = '';
        }
    }
    
    togglePermissions();
    if (roleSelect) {
        roleSelect.addEventListener('change', togglePermissions);
    }
});
</script>
{% endblock extrajs %}
