{% extends "suppliers/layouts/base.html" %}

{% load crispy_forms_tags %}

{% load static %}

{% block title %}Criar Fornecedor - Gestão Fiscal{% endblock title %}

{% block titlebody %}
<div class="container-xl mt-3">
    <div class="row g-2 align-items-center">
        <div class="col">
            <h2 class="page-title">Fornecedores</h2>
        </div>
    </div>
</div>
{% endblock titlebody %}

{% block card_content %}
<form method="post">
    {% csrf_token %}
    {{ form|crispy }}
    <button type="submit" class="btn btn-primary">
        Salvar
    </button>
</form>
{% endblock card_content %}

{% block extrajs %}
<script>

    $('#id_postal_code').mask('00000-000');

    /* Função para buscar endereço pelo CEP
    */
    function buscarCep(cep) {
        cep = cep.replace(/\D/g, '');
        
        if (cep.length !== 8) {
            return;
        }
        
        $('#id_street, #id_district, #id_city_name, #id_state').prop('disabled', true);
        $('#id_street').val('Buscando...');
        $('#id_district').val('Buscando...');
        $('#id_city_name').val('Buscando...');
        $('#id_state').val('...');
        
        $.getJSON(`https://viacep.com.br/ws/${cep}/json/`, function(data) {
            if (!data.erro) {
                $('#id_street').val(data.logradouro || '');
                $('#id_district').val(data.bairro || '');
                $('#id_city_name').val(data.localidade || '');
                $('#id_state').val(data.uf || '');
                
                if (data.ibge) {
                    $('#id_city_ibge_code').val(data.ibge);
                }
                
                if (!data.logradouro) {
                    $('#id_street').focus();
                } else {
                    $('#id_number').focus();
                }
            } else {
                $('#id_street').val('');
                $('#id_district').val('');
                $('#id_city_name').val('');
                $('#id_state').val('');
                $('#id_city_ibge_code').val('');
                alert('CEP não encontrado!');
                $('#id_postal_code').focus();
            }
        })
        .fail(function() {
            $('#id_street').val('');
            $('#id_district').val('');
            $('#id_city_name').val('');
            $('#id_state').val('');
            $('#id_city_ibge_code').val('');
            alert('Erro ao buscar CEP. Verifique sua conexão com a internet.');
            $('#id_postal_code').focus();
        })
        .always(function() {
            $('#id_street, #id_district, #id_city_name, #id_state').prop('disabled', false);
        });
    }

    $('#id_postal_code').on('blur', function() {
        const cep = $(this).val();
        if (cep) {
            buscarCep(cep);
        }
    });

    $('#id_postal_code').on('keypress', function(e) {
        if (e.which === 13) {
            e.preventDefault();
            const cep = $(this).val();
            if (cep) {
                buscarCep(cep);
            }
        }
    });

</script>
{% endblock extrajs %}