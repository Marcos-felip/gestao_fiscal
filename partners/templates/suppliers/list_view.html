{% extends "administration/base.html" %}

{% load static %}

{% block title %}Fornecedores - Gestão Fiscal{% endblock title %}

{% block titlebody %}
<div class="flex items-center px-6 py-4">
    <h2 class="text-2xl font-semibold tracking-tight">Fornecedores</h2>
</div>
{% endblock titlebody %}

{% block content %}
<div 
    class="px-6 pb-6"
    x-data="{ 
        deleteModal: false, 
        selectedSupplier: { pk: null, name: '', deleteUrl: '' }
    }"
    @open-delete-modal.window="selectedSupplier = $event.detail; deleteModal = true"
>
    <!-- Filtros -->
    <c-card class="mb-4">
        <c-card.content class="pt-6">
            <form 
                class="flex flex-wrap gap-4 items-center"
                hx-get="{% url 'partners:supplier_list' %}" 
                hx-target="#suppliers-table-container" 
                hx-trigger="change from:.filter-control, submit" 
                hx-swap="innerHTML"
                hx-push-url="true"
            >
                <div class="relative flex-grow min-w-[200px]">
                    <svg xmlns="http://www.w3.org/2000/svg" class="absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none">
                        <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                        <path d="M10 10m-7 0a7 7 0 1 0 14 0a7 7 0 1 0 -14 0" />
                        <path d="M21 21l-6 -6" />
                    </svg>
                    <c-input 
                        type="text" 
                        class="filter-control pl-10" 
                        placeholder="Buscar por Nome/Razão Social ou CPF/CNPJ" 
                        name="search" 
                        value="{{ current_search }}"
                    />
                </div>

                <c-button type="submit" variant="default">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none">
                        <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                        <path d="M10 10m-7 0a7 7 0 1 0 14 0a7 7 0 1 0 -14 0" />
                        <path d="M21 21l-6 -6" />
                    </svg>
                    Buscar
                </c-button>
            </form>
        </c-card.content>
    </c-card>

    <div id="suppliers-table-container">
        {% include "suppliers/partials/supplier_table.html" %}
    </div>

    <!-- Modal de Desativação -->
    <c-dialog name="deleteModal">
        <c-dialog.content open_var="deleteModal" hide_action="deleteModal = false">
            <c-dialog.icon variant="destructive">
                <c-dialog.title>Desativar Fornecedor</c-dialog.title>
                <c-dialog.description>
                    Você realmente deseja desativar o fornecedor <strong x-text="selectedSupplier.name"></strong>?
                </c-dialog.description>
            </c-dialog.icon>
            
            <c-dialog.footer class="mt-4">
                <c-button variant="outline" type="button" @click="deleteModal = false">
                    Cancelar
                </c-button>
                <form 
                    id="delete-supplier-form"
                    method="POST"
                    x-bind:action="selectedSupplier.deleteUrl"
                    x-init="$watch('selectedSupplier.deleteUrl', value => { 
                        if(value) {
                            $el.setAttribute('hx-post', value);
                            htmx.process($el);
                        }
                    })"
                    hx-target="#suppliers-table-container" 
                    hx-swap="innerHTML"
                    @htmx:after-request="deleteModal = false"
                >
                    {% csrf_token %}
                    <c-button type="submit" variant="destructive">
                        Desativar
                    </c-button>
                </form>
            </c-dialog.footer>
        </c-dialog.content>
    </c-dialog>
</div>
{% endblock content %}
