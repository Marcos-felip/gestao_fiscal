{% extends "customers/layouts/base.html" %}

{% load crispy_forms_tags %}

{% block form_content %}
<form method="post" id="customer-form" class="space-y-6">
    {% csrf_token %}
    {{ form|crispy }}
    {{ form.media }}
    
    <div class="flex justify-between pt-4 border-t">
        <a href="{% url 'partners:customer_list' %}">
            <c-button variant="outline" type="button">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none">
                    <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                    <path d="M5 12l14 0" />
                    <path d="M5 12l6 6" />
                    <path d="M5 12l6 -6" />
                </svg>
                Voltar
            </c-button>
        </a>
        <c-button type="submit">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none">
                <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                <path d="M6 4h10l4 4v10a2 2 0 0 1 -2 2h-12a2 2 0 0 1 -2 -2v-12a2 2 0 0 1 2 -2" />
                <path d="M12 14m-2 0a2 2 0 1 0 4 0a2 2 0 1 0 -4 0" />
                <path d="M14 4l0 4l-6 0l0 -4" />
            </svg>
            Salvar Endere√ßo
        </c-button>
    </div>
</form>
{% endblock form_content %}

{% block extrajs %}
<script>
document.addEventListener('DOMContentLoaded', () => {
    const form = document.getElementById('customer-form');
    if (!form) return;
    
    const zipCodeField = form.querySelector('#id_zip_code');
    
    if (zipCodeField) {
        zipCodeField.addEventListener('input', function() {
            this.value = maskCEP(this.value);
        });
        
        zipCodeField.addEventListener('blur', async function() {
            const cep = this.value.replace(/\D/g, '');
            if (cep.length === 8) {
                try {
                    const response = await fetch(`https://viacep.com.br/ws/${cep}/json/`);
                    const data = await response.json();
                    if (!data.erro) {
                        const streetInput = form.querySelector('#id_street');
                        const neighborhoodInput = form.querySelector('#id_neighborhood');
                        const cityInput = form.querySelector('#id_city');
                        const stateInput = form.querySelector('#id_state');
                        
                        if (streetInput) streetInput.value = data.logradouro;
                        if (neighborhoodInput) neighborhoodInput.value = data.bairro;
                        if (cityInput) cityInput.value = data.localidade;
                        if (stateInput) stateInput.value = data.uf;
                    }
                } catch (error) {
                    console.error('Erro ao buscar CEP:', error);
                }
            }
        });
    }
});
</script>
{% endblock extrajs %}
