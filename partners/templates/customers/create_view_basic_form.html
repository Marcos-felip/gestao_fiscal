{% extends "customers/layouts/base.html" %}
{% load crispy_forms_tags %}

{% block form_content %}
<form method="post" id="customer-form" class="space-y-6"
      x-data="{
          personType: '{{ form.person_type.value|default:"PF" }}',
          cpf: '{{ form.cpf.value|default:"" }}',
          cnpj: '{{ form.cnpj.value|default:"" }}',
          cellphone: '{{ form.cellphone.value|default:"" }}'
      }">
    {% csrf_token %}
    {{ form|crispy }}
    {{ form.media }}
    
    <div class="flex justify-between pt-4 border-t">
        <a href="{% url 'partners:customer_list' %}">
            <c-button variant="outline" type="button">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none">
                    <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                    <path d="M5 12l14 0" />
                    <path d="M5 12l6 6" />
                    <path d="M5 12l6 -6" />
                </svg>
                Voltar
            </c-button>
        </a>
        <c-button type="submit">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none">
                <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                <path d="M6 4h10l4 4v10a2 2 0 0 1 -2 2h-12a2 2 0 0 1 -2 -2v-12a2 2 0 0 1 2 -2" />
                <path d="M12 14m-2 0a2 2 0 1 0 4 0a2 2 0 1 0 -4 0" />
                <path d="M14 4l0 4l-6 0l0 -4" />
            </svg>
            Salvar e Continuar
        </c-button>
    </div>
</form>
{% endblock form_content %}

{% block extrajs %}
<script>
document.addEventListener('alpine:init', () => {
    // Aplica máscaras e toggle de campos após o DOM estar pronto
    const form = document.getElementById('customer-form');
    if (!form) return;
    
    const personTypeSelect = form.querySelector('#id_person_type');
    const cpfField = form.querySelector('#id_cpf');
    const cnpjField = form.querySelector('#id_cnpj');
    const tradingNameField = form.querySelector('#id_trading_name');
    const cellphoneField = form.querySelector('#id_cellphone');
    
    function togglePersonType() {
        const personType = personTypeSelect?.value;
        const cpfContainer = cpfField?.closest('.mb-3');
        const cnpjContainer = cnpjField?.closest('.mb-3');
        const tradingNameContainer = tradingNameField?.closest('.mb-3');
        
        if (personType === 'PJ') {
            if (cnpjContainer) cnpjContainer.style.display = '';
            if (tradingNameContainer) tradingNameContainer.style.display = '';
            if (cpfContainer) cpfContainer.style.display = 'none';
        } else {
            if (cnpjContainer) cnpjContainer.style.display = 'none';
            if (tradingNameContainer) tradingNameContainer.style.display = 'none';
            if (cpfContainer) cpfContainer.style.display = '';
        }
    }
    
    if (cpfField) {
        cpfField.addEventListener('input', function() {
            this.value = maskCPF(this.value);
        });
    }
    
    if (cnpjField) {
        cnpjField.addEventListener('input', function() {
            this.value = maskCNPJ(this.value);
        });
    }
    
    if (cellphoneField) {
        cellphoneField.addEventListener('input', function() {
            this.value = maskPhone(this.value);
        });
    }
    
    if (personTypeSelect) {
        togglePersonType();
        personTypeSelect.addEventListener('change', togglePersonType);
    }
});
</script>
{% endblock extrajs %}
